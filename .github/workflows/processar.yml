name: Processar Pedido com IA

on:
  workflow_dispatch:
    inputs:
      repoName:
        required: true
      filePath:
        required: true

jobs:
  processar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install @google/generative-ai octokit
      - name: Executar script da IA
        run: |
          node -e '
            const { GoogleGenerativeAI } = require("@google/generative-ai");
            const { Octokit } = require("octokit");

            const genAI = new GoogleGenerativeAI("${{ secrets.GEMINI_API_KEY }}");
            const octokit = new Octokit({ auth: "${{ secrets.GITHUB_TOKEN }}" });

            async function run() {
              try {
                const owner = "Rain-Hub1";
                const repo = "${{ github.event.inputs.repoName }}";
                const path = "${{ github.event.inputs.filePath }}";
                    
                const { data: fileContent } = await octokit.request("GET /repos/{owner}/{repo}/contents/{path}", { owner, repo, path });
                const decodedContent = Buffer.from(fileContent.content, "base64").toString("utf-8");

                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const prompt = `Resuma o seguinte conteúdo em português: \n\n${decodedContent}`;
                const result = await model.generateContent(prompt);
                const summary = result.response.text();

                const response = { status: "concluido", summary: summary, originalContent: decodedContent, timestamp: new Date().toISOString() };
                const responseContent = Buffer.from(JSON.stringify(response, null, 2)).toString("base64");

                const { data: currentFile } = await octokit.request("GET /repos/{owner}/{repo}/contents/{path}", {
                  owner: "${{ github.repository_owner }}", repo: "${{ github.event.repository.name }}", path: "resposta.json"
                });

                await octokit.request("PUT /repos/{owner}/{repo}/contents/{path}", {
                  owner: "${{ github.repository_owner }}", repo: "${{ github.event.repository.name }}", path: "resposta.json",
                  message: "Atualiza resposta da IA", content: responseContent, sha: currentFile.sha
                });
              } catch (error) {
                const response = { status: "erro", message: error.message, timestamp: new Date().toISOString() };
                const responseContent = Buffer.from(JSON.stringify(response, null, 2)).toString("base64");
                const { data: currentFile } = await octokit.request("GET /repos/{owner}/{repo}/contents/{path}", { owner: "${{ github.repository_owner }}", repo: "${{ github.event.repository.name }}", path: "resposta.json" });
                await octokit.request("PUT /repos/{owner}/{repo}/contents/{path}", { owner: "${{ github.repository_owner }}", repo: "${{ github.event.repository.name }}", path: "resposta.json", message: "Erro da IA", content: responseContent, sha: currentFile.sha });
              }
            }
            run();
          '

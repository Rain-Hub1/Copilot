<!DOCTYPE html>
<html lang="pt-br" data-color-mode="auto" data-light-theme="light" data-dark-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA com GitHub Actions</title>
    <style>
        :root {
            --color-bg-default: #ffffff;
            --color-bg-subtle: #f6f8fa;
            --color-fg-default: #24292f;
            --color-border-default: #d0d7de;
            --color-btn-primary-bg: #2da44e;
            --color-btn-primary-hover-bg: #2c974b;
            --color-btn-primary-fg: #ffffff;
        }
        [data-color-mode="dark"] {
            --color-bg-default: #0d1117;
            --color-bg-subtle: #161b22;
            --color-fg-default: #c9d1d9;
            --color-border-default: #30363d;
            --color-btn-primary-bg: #238636;
            --color-btn-primary-hover-bg: #2ea043;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; 
            margin: 0;
            padding: 1rem;
            background-color: var(--color-bg-subtle); 
            color: var(--color-fg-default);
            line-height: 1.5;
        }
        main {
            max-width: 800px; 
            margin: auto;
        }
        /* Container Principal */
        #container {
            background-color: var(--color-bg-default); 
            border: 1px solid var(--color-border-default);
            border-radius: 6px; 
        }
        /* Cabeçalho e Abas */
        header {
            padding: 16px;
            border-bottom: 1px solid var(--color-border-default);
        }
        h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--color-border-default);
            margin-top: 16px;
        }
        .tab-nav button {
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 8px 16px;
            color: var(--color-fg-default);
            font-weight: 600;
            cursor: pointer;
            margin-bottom: -1px; /* Alinha com a borda inferior */
        }
        .tab-nav button.active {
            border-bottom-color: var(--color-btn-primary-bg);
        }
        /* Conteúdo das Abas */
        .tab-content {
            padding: 16px;
        }
        #chats-tab {
            display: none; /* Esconde a aba de chats por padrão */
        }
        /* Elementos de Formulário */
        button.primary { 
            cursor: pointer; 
            padding: 10px 15px; 
            border-radius: 6px; 
            border: 1px solid var(--color-border-default);
            font-weight: 600; 
            background-color: var(--color-btn-primary-bg); 
            color: var(--color-btn-primary-fg);
            width: 100%;
            margin-top: 10px;
        }
        button.primary:hover {
            background-color: var(--color-btn-primary-hover-bg);
        }
        select, input { 
            width: 100%; 
            padding: 8px 12px; 
            margin-bottom: 16px; 
            border-radius: 6px; 
            border: 1px solid var(--color-border-default);
            background-color: var(--color-bg-default);
            color: var(--color-fg-default);
            box-sizing: border-box;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        hr {
            border: none;
            border-top: 1px solid var(--color-border-default);
            margin: 16px 0;
        }
        pre { 
            background-color: var(--color-bg-subtle); 
            padding: 16px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            border-radius: 6px; 
            border: 1px solid var(--color-border-default);
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <main>
        <div id="container">
            <header>
                <h1>IA Leitora de Repositórios</h1>
            </header>

            <div id="login-view" class="tab-content">
                <p>Para começar, conecte-se com sua conta do GitHub. Isso permitirá que o site liste seus repositórios de forma segura.</p>
                <button class="primary" onclick="loginComGithub()">Login com GitHub</button>
            </div>

            <div id="app-view" style="display:none;">
                <nav class="tab-nav">
                    <button id="tab-leitor" class="active" onclick="switchTab('leitor')">Leitor de Arquivos</button>
                    <button id="tab-chats" onclick="switchTab('chats')">Chats</button>
                </nav>

                <div id="leitor-tab" class="tab-content">
                    <p>Selecione um repositório e um arquivo para a IA ler e resumir.</p>
                    <label for="repo-select">Seus Repositórios:</label>
                    <select id="repo-select" onchange="listarArquivos(this.value)"></select>
                    
                    <label for="file-select">Arquivos no Repositório:</label>
                    <select id="file-select"></select>
                    
                    <button class="primary" onclick="dispararAction()">Ler e Resumir com IA</button>
                    <hr>
                    <h2>Resultado:</h2>
                    <p id="summary">Aguardando comando...</p>
                    <pre id="content"></pre>
                </div>

                <div id="chats-tab" class="tab-content">
                    <h2>Chat com a IA</h2>
                    <p>Esta funcionalidade está em desenvolvimento. Em breve, você poderá conversar com a IA sobre seus repositórios aqui.</p>
                    <pre>Exemplo de como poderia ser:

Você: Crie um arquivo chamado 'teste.js' no repositório 'meu-site-ia-final' com uma função de soma.

IA: Entendido. Criando o arquivo 'teste.js' com o conteúdo solicitado...</pre>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <script>
        // Configuração do seu projeto Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyC0JUKA-uIHMpxLRtv7BwraOph3QOamxhA",
          authDomain: "github-ai-a4fcb.firebaseapp.com",
          projectId: "github-ai-a4fcb",
          storageBucket: "github-ai-a4fcb.appspot.com",
          messagingSenderId: "99989504065",
          appId: "1:99989504065:web:fa916d2c5f69d44f9006c0"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Variáveis globais
        let userToken = null;
        let lastTimestamp = null;
        const githubUser = "Rain-Hub1";
        const repoDoAction = "meu-site-ia-final";
        let intervalId = null;

        // Função para trocar de abas
        function switchTab(tabName) {
            document.getElementById('leitor-tab').style.display = 'none';
            document.getElementById('chats-tab').style.display = 'none';
            document.getElementById('tab-leitor').classList.remove('active');
            document.getElementById('tab-chats').classList.remove('active');

            document.getElementById(tabName + '-tab').style.display = 'block';
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Função para fazer login com o GitHub via Firebase
        function loginComGithub() {
            const provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('repo'); 
            auth.signInWithPopup(provider).then(result => {
                userToken = result.credential.accessToken;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('app-view').style.display = 'block';
                switchTab('leitor'); // Garante que a aba correta seja mostrada
                listarRepositorios();
            }).catch(error => {
                console.error("Erro de login:", error);
                alert("Ocorreu um erro ao fazer login.");
            });
        }

        // Função para buscar e listar seus repositórios
        async function listarRepositorios() {
            const select = document.getElementById('repo-select');
            select.innerHTML = '<option>Carregando...</option>';
            try {
                const response = await fetch(`https://api.github.com/users/${githubUser}/repos?sort=updated`, {
                    headers: { 'Authorization': `token ${userToken}` }
                });
                const repos = await response.json();
                select.innerHTML = '<option value="">Selecione um repositório</option>';
                repos.forEach(repo => {
                    const option = new Option(repo.name, repo.name);
                    select.add(option);
                });
            } catch (error) {
                console.error("Erro ao listar repositórios:", error);
                select.innerHTML = '<option>Falha ao carregar</option>';
            }
        }

        // Função para buscar e listar os arquivos de um repositório selecionado
        async function listarArquivos(repoName) {
            const select = document.getElementById('file-select');
            if (!repoName) {
                select.innerHTML = '';
                return;
            }
            select.innerHTML = '<option>Carregando...</option>';
            try {
                const response = await fetch(`https://api.github.com/repos/${githubUser}/${repoName}/contents/`, {
                    headers: { 'Authorization': `token ${userToken}` }
                });
                const files = await response.json();
                select.innerHTML = '<option value="">Selecione um arquivo</option>';
                files.filter(file => file.type === 'file').forEach(file => {
                    const option = new Option(file.path, file.path);
                    select.add(option);
                });
            } catch (error) {
                console.error("Erro ao listar arquivos:", error);
                select.innerHTML = '<option>Falha ao carregar</option>';
            }
        }

        // Função para disparar o GitHub Action
        async function dispararAction() {
            if (!userToken) { alert("Faça o login primeiro!"); return; }
            const repoName = document.getElementById('repo-select').value;
            const filePath = document.getElementById('file-select').value;
            if (!repoName || !filePath) {
                alert("Por favor, selecione um repositório e um arquivo.");
                return;
            }
            document.getElementById('summary').innerText = 'Disparando a IA no GitHub Actions... O resultado pode levar até 2 minutos. Fique de olho aqui!';
            document.getElementById('content').innerText = '';
            if (intervalId) clearInterval(intervalId);

            try {
                await fetch(`https://api.github.com/repos/${githubUser}/${repoDoAction}/actions/workflows/processar.yml/dispatches`, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${userToken}`, 'Accept': 'application/vnd.github.v3+json' },
                    body: JSON.stringify({ ref: 'main', inputs: { repoName, filePath } })
                });
                setTimeout(() => {
                    lastTimestamp = null;
                    verificarResposta();
                    intervalId = setInterval(verificarResposta, 7000);
                }, 15000);
            } catch (error) {
                console.error("Erro ao disparar o Action:", error);
                document.getElementById('summary').innerText = 'Falha ao disparar o Action.';
            }
        }

        // Função que verifica o arquivo resposta.json
        async function verificarResposta() {
            const url = `https://raw.githubusercontent.com/${githubUser}/${repoDoAction}/main/resposta.json?t=${Date.now()}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.timestamp && data.timestamp !== lastTimestamp) {
                    lastTimestamp = data.timestamp;
                    clearInterval(intervalId);
                    if (data.status === 'concluido') {
                        document.getElementById('summary').innerText = data.summary;
                        document.getElementById('content').innerText = data.originalContent;
                    } else if (data.status === 'erro') {
                        document.getElementById('summary').innerText = `Erro na IA: ${data.message}`;
                        document.getElementById('content').innerText = '';
                    }
                } else {
                    document.getElementById('summary').innerText += ".";
                }
            } catch (error) {
                console.error("Erro ao verificar resposta:", error);
            }
        }
    </script>
</body>
</html>
